import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import './AdminDashboard.css';

const AdminDashboard = () => {
  const [stats, setStats] = useState({
    totalSales: 0,
    totalOrders: 0,
    pendingOrders: 0,
    completedOrders: 0,
    totalUsers: 0,
    totalProducts: 0,
    lowStockProducts: 0
  });

  const [recentOrders, setRecentOrders] = useState([]);

  useEffect(() => {
    calculateStats();
    loadRecentOrders();

    const handleUpdate = () => {
      calculateStats();
      loadRecentOrders();
    };

    window.addEventListener('storage', handleUpdate);
    window.addEventListener('orderUpdated', handleUpdate);

    return () => {
      window.removeEventListener('storage', handleUpdate);
      window.removeEventListener('orderUpdated', handleUpdate);
    };
  }, []);

  const calculateStats = () => {
    const orders = JSON.parse(localStorage.getItem('dkmerch_orders')) || [];
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const products = JSON.parse(localStorage.getItem('dkmerch_products')) || [];

    // ✅ FILTER ONLY VALID ORDERS WITH ITEMS
    const validOrders = orders.filter(order => {
      return order && 
             order.items && 
             Array.isArray(order.items) && 
             order.items.length > 0;
    });

    const completedOrders = validOrders.filter(o => o.orderStatus === 'completed');
    const pendingOrders = validOrders.filter(o => 
      o.orderStatus === 'pending' || o.orderStatus === 'confirmed'
    );

    const totalSales = completedOrders.reduce((sum, order) => sum + (order.total || 0), 0);
    const lowStockProducts = products.filter(p => p.stock < 10);

    setStats({
      totalSales,
      totalOrders: validOrders.length,
      pendingOrders: pendingOrders.length,
      completedOrders: completedOrders.length,
      totalUsers: users.filter(u => u.role === 'user').length,
      totalProducts: products.length,
      lowStockProducts: lowStockProducts.length
    });
  };

  const loadRecentOrders = () => {
    const orders = JSON.parse(localStorage.getItem('dkmerch_orders')) || [];
    
    // ✅ FILTER ONLY VALID ORDERS WITH ITEMS AND ORDER ID
    const validOrders = orders.filter(order => {
      return order && 
             order.orderId && 
             order.items && 
             Array.isArray(order.items) && 
             order.items.length > 0;
    });

    const sorted = validOrders
      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
      .slice(0, 5);
    
    setRecentOrders(sorted);
  };

  const getStatusColor = (status) => {
    const colors = {
      pending: '#ffc107',
      confirmed: '#17a2b8',
      packed: '#6610f2',
      shipped: '#007bff',
      completed: '#28a745',
      cancelled: '#dc3545'
    };
    return colors[status] || '#6c757d';
  };

  return (
    <div className="admin-dashboard">
      {/* Stats Cards */}
      <div className="stats-grid">
        <div className="stat-card sales">
          <div className="stat-icon">
            <i className="fas fa-peso-sign"></i>
          </div>
          <div className="stat-details">
            <h3>Total Sales</h3>
            <p className="stat-value">₱{stats.totalSales.toLocaleString()}</p>
            <span className="stat-label">From {stats.completedOrders} completed orders</span>
          </div>
        </div>

        <div className="stat-card orders">
          <div className="stat-icon">
            <i className="fas fa-shopping-cart"></i>
          </div>
          <div className="stat-details">
            <h3>Total Orders</h3>
            <p className="stat-value">{stats.totalOrders}</p>
            <span className="stat-label">{stats.pendingOrders} pending orders</span>
          </div>
        </div>

        <div className="stat-card users">
          <div className="stat-icon">
            <i className="fas fa-users"></i>
          </div>
          <div className="stat-details">
            <h3>Registered Users</h3>
            <p className="stat-value">{stats.totalUsers}</p>
            <span className="stat-label">Active customers</span>
          </div>
        </div>

        <div className="stat-card products">
          <div className="stat-icon">
            <i className="fas fa-box"></i>
          </div>
          <div className="stat-details">
            <h3>Total Products</h3>
            <p className="stat-value">{stats.totalProducts}</p>
            <span className="stat-label warn">
              {stats.lowStockProducts} low stock items
            </span>
          </div>
        </div>
      </div>

      {/* Recent Orders */}
      <div className="recent-orders">
        <div className="section-header">
          <h2>Recent Orders</h2>
          <Link to="/admin/orders" className="view-all">View All →</Link>
        </div>

        {recentOrders.length === 0 ? (
          <div className="empty-state">
            <i className="fas fa-inbox"></i>
            <p>No orders yet</p>
          </div>
        ) : (
          <div className="orders-table">
            <table>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                {recentOrders.map(order => (
                  <tr key={order.orderId}>
                    <td>
                      <strong>#{order.orderId?.slice(-8) || 'N/A'}</strong>
                    </td>
                    <td>{order.customerName || 'N/A'}</td>
                    <td>₱{(order.total || 0).toLocaleString()}</td>
                    <td>
                      <span 
                        className="status-badge"
                        style={{ backgroundColor: getStatusColor(order.orderStatus) }}
                      >
                        {order.orderStatus || 'pending'}
                      </span>
                    </td>
                    <td>
                      {order.createdAt 
                        ? new Date(order.createdAt).toLocaleDateString('en-PH')
                        : 'N/A'
                      }
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
};

export default AdminDashboard;